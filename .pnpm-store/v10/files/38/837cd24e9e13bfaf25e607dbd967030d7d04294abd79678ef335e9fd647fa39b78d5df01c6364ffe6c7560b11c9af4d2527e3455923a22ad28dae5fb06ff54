"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const a=require("valibot"),w=require("better-promises"),f=require("@telegram-apps/toolkit"),l=require("@telegram-apps/transformers"),X=require("mitt"),M=require("@telegram-apps/signals"),d=require("error-kid");function k(e){return a.is(a.looseObject({TelegramWebviewProxy:a.looseObject({postEvent:a.function()})}),e)}function q(){try{return window.self!==window.top}catch{return!0}}function Z(e,r){const t=X(),o=new Map,i=(n,s,c)=>{c||(c=!1);const p=o.get(n)||new Map;o.set(n,p);const _=p.get(s)||[];p.set(s,_);const b=_.findIndex(h=>h[1]===c);b>=0&&(t.off(n,_[b][0]),_.splice(b,1),!_.length&&p.delete(s),p.size||(o.delete(n),!o.size&&r()))};return[function(s,c,p){!o.size&&e();function _(){i(s,c,p)}function b(...x){p&&_(),s==="*"?c(x):c(...x)}t.on(s,b);const h=o.get(s)||new Map;o.set(s,h);const j=h.get(c)||[];return h.set(c,j),j.push([b,p||!1]),_},i,t.emit,function(){const s=t.all.size;t.all.clear(),o.clear(),s&&r()}]}function y(e,r){window.dispatchEvent(new MessageEvent("message",{data:JSON.stringify({eventType:e,eventData:r}),source:window.parent}))}let v=!1;const C=e=>{m().log("Event received:",e)};function $(e){e!==v&&(v=e,v?L("*",C):O("*",C))}const m=M.signal(f.createLogger("Bridge",{bgColor:"#9147ff",textColor:"white",shouldLog(){return v}})),V={clipboard_text_received:a.looseObject({req_id:a.string(),data:a.nullish(a.string())}),custom_method_invoked:a.looseObject({req_id:a.string(),result:a.optional(a.unknown()),error:a.optional(a.string())}),popup_closed:a.nullish(a.looseObject({button_id:a.nullish(a.string(),()=>{})}),{}),viewport_changed:a.looseObject({height:a.number(),width:a.nullish(a.number(),()=>window.innerWidth),is_state_stable:a.boolean(),is_expanded:a.boolean()}),theme_changed:a.looseObject({theme_params:l.themeParams()})};function U(e){if(e.source!==window.parent)return;let r;try{r=a.parse(a.pipe(a.string(),l.jsonParse(),l.MiniAppsMessageSchema),e.data)}catch{return}const{eventType:t,eventData:o}=r,i=V[t];let n;try{n=i?a.parse(i,o):o}catch(s){return m().forceError([`An error occurred processing the "${t}" event from the Telegram application.`,"Please, file an issue here:","https://github.com/Telegram-Mini-Apps/telegram-apps/issues/new/choose"].join(`
`),r,s)}ee(t,n)}const[L,O,ee,D]=Z(()=>{const e=window,r={receiveEvent:y};e.TelegramGameProxy_receiveEvent=y,e.TelegramGameProxy=r,e.Telegram={WebView:r},window.addEventListener("message",U)},()=>{["TelegramGameProxy_receiveEvent","TelegramGameProxy","Telegram"].forEach(e=>{delete window[e]}),window.removeEventListener("message",U)}),[N,re]=d.errorClass("MethodUnsupportedError",(e,r)=>[`Method "${e}" is unsupported in Mini Apps version ${r}`]),[Q,te]=d.errorClass("MethodParameterUnsupportedError",(e,r,t)=>[`Parameter "${r}" of "${e}" method is unsupported in Mini Apps version ${t}`]),[z,oe]=d.errorClassWithData("LaunchParamsRetrieveError",e=>({errors:e}),e=>[["Unable to retrieve launch parameters from any known source. Perhaps, you have opened your app outside Telegram?","ðŸ“– Refer to docs for more information:","https://docs.telegram-mini-apps.com/packages/telegram-apps-bridge/environment","","Collected errors:",...e.map(([r,t])=>`Source: ${r} / ${t instanceof Error?t.message:String(t)}`)].join(`
`)]),[G,ae]=d.errorClass("InvalidLaunchParamsError",(e,r)=>[`Invalid value for launch params: ${e}`,{cause:r}]),[J,ne]=d.errorClass("UnknownEnvError"),[K,se]=d.errorClass("InvokeCustomMethodError",e=>[`Server returned error: ${e}`]),g=M.signal((...e)=>{try{window.parent.postMessage(...e)}catch(r){r instanceof SyntaxError?m().forceError("Unable to call window.parent.postMessage due to incorrectly configured target origin. Use the setTargetOrigin method to allow this origin to receive events",r):m().forceError(r)}}),B=(...e)=>g()(...e),E=M.signal("https://web.telegram.org");function ie(e){E.set(e),m().log("New target origin set",e)}function S(e,r){m().log("Posting event:",r?{eventType:e,eventData:r}:{eventType:e});const t=window,o=JSON.stringify({eventType:e,eventData:r});if(q())return B(o,E());if(k(t)){t.TelegramWebviewProxy.postEvent(e,JSON.stringify(r));return}if(a.is(a.looseObject({external:a.looseObject({notify:a.function()})}),t)){t.external.notify(o);return}throw new J}function A(e,r,t){t||(t={});const{capture:o}=t,[i,n]=f.createCbCollector();return new w.AbortablePromise(s=>{(Array.isArray(r)?r:[r]).forEach(c=>{i(L(c,p=>{(!o||(Array.isArray(r)?o({event:c,payload:p}):o(p)))&&s(p)}))}),(t.postEvent||S)(e,t.params)},t).finally(n)}const I="launchParams";function R(e){return e.replace(/^[^?#]*[?#]/,"").replace(/[?#]/g,"&")}function T(){const e=[];for(const[r,t]of[[()=>R(window.location.href),"window.location.href"],[()=>{const o=performance.getEntriesByType("navigation")[0];return o&&R(o.name)},"performance navigation entries"],[()=>f.getStorageValue(I),"local storage"]]){const o=r();if(!o){e.push([t,new Error("Source is empty")]);continue}if(l.isLaunchParamsQuery(o))return f.setStorageValue(I,o),o;try{l.parseLaunchParamsQuery(o)}catch(i){e.push([t,i])}}throw new z(e)}function Y(e){const r=l.parseLaunchParamsQuery(T());return e?f.deepSnakeToCamelObjKeys(r):r}function ce(e,r){if(!e)try{return Y(),!0}catch{return!1}return w.AbortablePromise.fn(async t=>{if(k(window))return!0;try{return await A("web_app_request_theme","theme_changed",t),!0}catch{return!1}},r||{timeout:100})}function pe({launchParams:e,onEvent:r,resetPostMessage:t}={}){if(e){const n=typeof e=="string"||e instanceof URLSearchParams?e.toString():l.serializeLaunchParamsQuery({...e,tgWebAppData:void 0})+(e.tgWebAppData?`&tgWebAppData=${encodeURIComponent(e.tgWebAppData.toString())}`:"");if(!l.isLaunchParamsQuery(n))try{l.parseLaunchParamsQuery(n)}catch(s){throw new G(n,s)}f.setStorageValue("launchParams",n)}if(q()){if(!r)return;const n=a.pipe(a.string(),l.jsonParse(),l.MiniAppsMessageSchema);t&&g.reset();const s=g();g.set((...c)=>{const[p]=c,_=()=>{s(...c)};if(a.is(n,p)){const b=a.parse(n,p);r([b.eventType,b.eventData],_)}else _()});return}const o=window.TelegramWebviewProxy||{},i=o.postEvent||(()=>{});window.TelegramWebviewProxy={...o,postEvent(n,s){const c=()=>{i(n,s)};r?r([n,s?JSON.parse(s):void 0],c):c()}},m().log("Environment was mocked by the mockTelegramEnv function")}function ue(){return new URLSearchParams(T()).get("tgWebAppData")||void 0}function F(e){return({req_id:r})=>r===e}function W(e){return e.split(".").map(Number)}function H(e,r){const t=W(e),o=W(r),i=Math.max(t.length,o.length);for(let n=0;n<i;n+=1){const s=t[n]||0,c=o[n]||0;if(s!==c)return s>c?1:-1}return 0}function u(e,r){return H(e,r)<=0}function P(e,r,t){if(typeof t=="string"){if(e==="web_app_open_link"){if(r==="try_instant_view")return u("6.4",t);if(r==="try_browser")return u("7.6",t)}if(e==="web_app_set_header_color"&&r==="color")return u("6.9",t);if(e==="web_app_close"&&r==="return_back")return u("7.6",t);if(e==="web_app_setup_main_button"&&r==="has_shine_effect")return u("7.10",t)}switch(e){case"web_app_open_tg_link":case"web_app_open_invoice":case"web_app_setup_back_button":case"web_app_set_background_color":case"web_app_set_header_color":case"web_app_trigger_haptic_feedback":return u("6.1",r);case"web_app_open_popup":return u("6.2",r);case"web_app_close_scan_qr_popup":case"web_app_open_scan_qr_popup":case"web_app_read_text_from_clipboard":return u("6.4",r);case"web_app_switch_inline_query":return u("6.7",r);case"web_app_invoke_custom_method":case"web_app_request_write_access":case"web_app_request_phone":return u("6.9",r);case"web_app_setup_settings_button":return u("6.10",r);case"web_app_biometry_get_info":case"web_app_biometry_open_settings":case"web_app_biometry_request_access":case"web_app_biometry_request_auth":case"web_app_biometry_update_token":return u("7.2",r);case"web_app_setup_swipe_behavior":return u("7.7",r);case"web_app_share_to_story":return u("7.8",r);case"web_app_setup_secondary_button":case"web_app_set_bottom_bar_color":return u("7.10",r);case"web_app_request_safe_area":case"web_app_request_content_safe_area":case"web_app_request_fullscreen":case"web_app_exit_fullscreen":case"web_app_set_emoji_status":case"web_app_add_to_home_screen":case"web_app_check_home_screen":case"web_app_request_emoji_status_access":case"web_app_check_location":case"web_app_open_location_settings":case"web_app_request_file_download":case"web_app_request_location":case"web_app_send_prepared_message":case"web_app_start_accelerometer":case"web_app_start_device_orientation":case"web_app_start_gyroscope":case"web_app_stop_accelerometer":case"web_app_stop_device_orientation":case"web_app_stop_gyroscope":case"web_app_toggle_orientation_lock":return u("8.0",r);default:return["iframe_ready","iframe_will_reload","web_app_close","web_app_data_send","web_app_expand","web_app_open_link","web_app_ready","web_app_request_theme","web_app_request_viewport","web_app_setup_main_button","web_app_setup_closing_behavior"].includes(e)}}function _e(e,r){r||(r="strict");const t=typeof r=="function"?r:o=>{const{method:i,version:n}=o,s="param"in o?new Q(i,o.param,n):new N(i,n);if(r==="strict")throw s;return m().forceWarn(s.message)};return(o,i)=>P(o,e)?o==="web_app_set_header_color"&&a.is(a.looseObject({color:a.any()}),i)&&!P(o,"color",e)?t({version:e,method:o,param:"color"}):S(o,i):t({version:e,method:o})}function le(e,r,t,o){return A("web_app_invoke_custom_method","custom_method_invoked",{...o||{},params:{method:e,params:r,req_id:t},capture:F(t)}).then(({result:i,error:n})=>{if(n)throw new K(n);return i})}function be(){D(),$(!1),[g,E].forEach(e=>{e.unsubAll(),e.reset()})}Object.defineProperty(exports,"AbortablePromise",{enumerable:!0,get:()=>w.AbortablePromise});Object.defineProperty(exports,"CancelledError",{enumerable:!0,get:()=>w.CancelledError});Object.defineProperty(exports,"ManualPromise",{enumerable:!0,get:()=>w.ManualPromise});Object.defineProperty(exports,"TimeoutError",{enumerable:!0,get:()=>w.TimeoutError});Object.defineProperty(exports,"isCancelledError",{enumerable:!0,get:()=>w.isCancelledError});Object.defineProperty(exports,"isTimeoutError",{enumerable:!0,get:()=>w.isTimeoutError});Object.defineProperty(exports,"createLogger",{enumerable:!0,get:()=>f.createLogger});exports.InvalidLaunchParamsError=G;exports.InvokeCustomMethodError=K;exports.LaunchParamsRetrieveError=z;exports.MethodParameterUnsupportedError=Q;exports.MethodUnsupportedError=N;exports.UnknownEnvError=J;exports.captureSameReq=F;exports.compareVersions=H;exports.createPostEvent=_e;exports.emitEvent=y;exports.hasWebviewProxy=k;exports.invokeCustomMethod=le;exports.isIframe=q;exports.isInvalidLaunchParamsError=ae;exports.isInvokeCustomMethodError=se;exports.isLaunchParamsRetrieveError=oe;exports.isMethodMethodParameterUnsupportedError=te;exports.isMethodUnsupportedError=re;exports.isTMA=ce;exports.isUnknownEnvError=ne;exports.logger=m;exports.mockTelegramEnv=pe;exports.off=O;exports.offAll=D;exports.on=L;exports.postEvent=S;exports.postMessage=B;exports.postMessageImplementation=g;exports.request=A;exports.resetPackageState=be;exports.retrieveLaunchParams=Y;exports.retrieveRawInitData=ue;exports.retrieveRawLaunchParams=T;exports.setDebug=$;exports.setTargetOrigin=ie;exports.supports=P;exports.targetOrigin=E;
//# sourceMappingURL=index.cjs.map
